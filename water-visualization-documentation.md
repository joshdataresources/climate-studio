# Water Access Visualization - Complete Documentation for QGIS

## 1. Data Sources

### Primary Data Files

#### rivers-with-depletion.json (4.8MB)
**Location**: `/Users/joshuabutler/Documents/github-project/climate-suite/apps/climate-studio/src/data/rivers-with-depletion.json`

**Source**: Generated by merging Natural Earth river geometry with flow depletion status

**Structure**:
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": [[lon, lat], ...]
      },
      "properties": {
        "name": "River Name",
        "scalerank": 0-10,
        "flow_status": "dry|seasonal|reduced|natural",
        "impact_source": "Dam/Diversion Name" (optional)
      }
    }
  ]
}
```

**Key Properties**:
- `flow_status`: Controls river color
  - `"dry"` â†’ Red (#dc2626) - Perennially dry; complete diversion
  - `"seasonal"` â†’ Orange (#f59e0b) - Flow only during wet season or flood releases
  - `"reduced"` â†’ Yellow (#fbbf24) - 50%+ reduction from historical levels
  - `"natural"` â†’ Blue (#3b82f6) - Unimpacted natural flow
- `scalerank`: Controls line width (0=major rivers, 10=minor streams)
- `impact_source`: Optional property indicating dam/diversion causing depletion

---

#### water-service-areas.json
**Location**: `/Users/joshuabutler/Documents/github-project/climate-suite/apps/climate-studio/src/data/water-service-areas.json`

**Source**: Compiled from water district data and municipal water reports

**Structure**:
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [lon, lat]
      },
      "properties": {
        "city": "City Name",
        "state": "State Code",
        "population": 123456,
        "water_source": "Source Description",
        "source_type": "Source Type",
        "infrastructure": "Infrastructure System",
        "dependency": "extreme|high|moderate|low",
        "description": "Description",
        "infrastructure_type": "service_area"
      }
    }
  ]
}
```

**Dependency Levels**:
- `"extreme"`: 90-100% dependency on source
- `"high"`: 60-90% dependency
- `"moderate"`: 30-60% dependency
- `"low"`: <30% dependency

**Example Cities**:
- Phoenix, AZ: CAP (Central Arizona Project), high dependency
- Tucson, AZ: CAP, high dependency
- Los Angeles, CA: CRA (Colorado River Aqueduct), high dependency
- Las Vegas, NV: Lake Mead direct intake, extreme dependency

---

#### enhanced-water-infrastructure.json (No longer displayed, but contains reference data)
**Location**: `/Users/joshuabutler/Documents/github-project/climate-suite/apps/climate-studio/src/data/enhanced-water-infrastructure.json`

**Source**: Generated by create_enhanced_water_infrastructure.py

**Contains**:
1. **Impacted River Segments** (8 features): Detailed geometry following actual river paths with flow_status
2. **Aqueduct Routes** (3 features): CAP, Colorado River Aqueduct, All-American Canal
3. **Infrastructure Connections** (6 features): Damâ†’canalâ†’city relationships

**Note**: This data is now embedded in rivers-with-depletion.json via flow_status property

---

#### north_america_rivers.json
**Location**: `/Users/joshuabutler/Documents/github-project/climate-suite/apps/climate-studio/src/data/north_america_rivers.json`

**Source**: Natural Earth river geometry (unmodified base data)

**Used By**: merge_river_depletion.py as input to create rivers-with-depletion.json

---

### External Data Sources

#### GRACE Satellite Data
**Type**: Raster tiles
**Format**: Mapbox GL tile layer
**Source URL**: Custom tile server endpoint
**Description**: NASA GRACE (Gravity Recovery and Climate Experiment) groundwater depletion zones

#### Aquifers Data
**Type**: Vector polygons
**Format**: GeoJSON or Mapbox source
**Description**: Major groundwater aquifer boundaries

---

## 2. Python Scripts

## IMPORTANT UPDATE: Removed Dashed Aqueduct Lines

**Recent Change**: The dashed aqueduct lines from OSM data have been removed. Only solid cyan canal/aqueduct lines are now displayed.

**What was removed**:
- `aqueduct-lines` layer with `line-dasharray: [2, 2]` (dashed lines)
- Import of `aqueductsData` from aqueducts.json

**What remains**:
- `canal-lines` layer (solid cyan #06b6d4)
- `canal-lines-casing` layer (dark cyan #0891b2)
- Data source: `enhanced-water-infrastructure.json` (filtered for `infrastructure_type === 'aqueduct'`)

**New layer control**: "Canals & Aqueducts" toggle added to left sidebar

---

### Script 1: create_enhanced_water_infrastructure.py

**Purpose**: Creates comprehensive water infrastructure GeoJSON with detailed geometry

**Location**: `/tmp/create_enhanced_water_infrastructure.py`

**Full Code**:
```python
#!/usr/bin/env python3
"""
Create enhanced water infrastructure GeoJSON with:
1. Detailed impacted river segments following actual river paths
2. Complete aqueduct routes including full CAP to Tucson
3. Infrastructure connection lines showing dam â†’ canal â†’ city relationships
"""
import json
import sys

def create_enhanced_infrastructure():
    """
    Create comprehensive water infrastructure data
    """

    # === IMPACTED RIVERS with detailed geometry ===
    impacted_rivers = [
        # Colorado River below Hoover Dam - following actual river path
        {
            "name": "Colorado River below Hoover Dam",
            "river": "Colorado River",
            "impact_source": "Hoover Dam",
            "flow_status": "reduced",
            "coordinates": [
                [-114.7377, 36.0161],   # Hoover Dam
                [-114.7200, 35.9800],
                [-114.6900, 35.9200],
                [-114.6500, 35.8400],
                [-114.6200, 35.7200],
                [-114.5900, 35.5800],
                [-114.5800, 35.4200],
                [-114.5750, 35.3000],
                [-114.5703, 35.2019],   # Davis Dam
            ],
            "description": "Flow heavily regulated by Hoover Dam; reduced from natural levels"
        },
        # Colorado River below Davis Dam to Parker Dam
        {
            "name": "Colorado River below Davis Dam",
            "river": "Colorado River",
            "impact_source": "Davis Dam / Parker Dam",
            "flow_status": "reduced",
            "coordinates": [
                [-114.5703, 35.2019],   # Davis Dam
                [-114.5400, 35.1200],
                [-114.5100, 35.0200],
                [-114.4800, 34.9200],
                [-114.4200, 34.7800],
                [-114.3600, 34.6200],
                [-114.2800, 34.4800],
                [-114.1800, 34.3600],
                [-114.1364, 34.2939],   # Parker Dam
            ],
            "description": "Sequential dam regulation; significant flow reduction"
        },
        # Colorado River below Parker Dam (major extraction point)
        {
            "name": "Colorado River below Parker Dam",
            "river": "Colorado River",
            "impact_source": "Parker Dam (CAP/CRA extraction)",
            "flow_status": "reduced",
            "coordinates": [
                [-114.1364, 34.2939],   # Parker Dam
                [-114.2000, 34.2000],
                [-114.2500, 34.0800],
                [-114.3200, 33.9600],
                [-114.3800, 33.8200],
                [-114.4200, 33.6800],
                [-114.4400, 33.4800],
                [-114.4500, 33.2800],
                [-114.4533, 32.8756],   # Imperial Dam
            ],
            "description": "Major diversions to CAP and Colorado River Aqueduct; 50% flow reduction"
        },
        # Colorado River below Imperial Dam
        {
            "name": "Colorado River below Imperial Dam",
            "river": "Colorado River",
            "impact_source": "Imperial Dam (All-American Canal)",
            "flow_status": "seasonal",
            "coordinates": [
                [-114.4533, 32.8756],   # Imperial Dam
                [-114.5000, 32.8400],
                [-114.5800, 32.7900],
                [-114.6500, 32.7500],
                [-114.7214, 32.7186],   # Morelos Dam
            ],
            "description": "All-American Canal diversion; seasonal flow"
        },
        # Colorado River Delta (usually dry)
        {
            "name": "Colorado River Delta",
            "river": "Colorado River",
            "impact_source": "Morelos Dam (last diversion)",
            "flow_status": "dry",
            "coordinates": [
                [-114.7214, 32.7186],   # Morelos Dam
                [-114.7500, 32.5800],
                [-114.7800, 32.4200],
                [-114.8000, 32.2400],
                [-114.8200, 32.0600],
                [-114.8500, 31.8700],   # Historical delta
            ],
            "description": "River rarely reaches ocean; delta ecosystem severely impacted"
        },
        # Salt River below Roosevelt Dam (completely dry)
        {
            "name": "Salt River below Roosevelt Dam",
            "river": "Salt River",
            "impact_source": "Roosevelt Dam",
            "flow_status": "dry",
            "coordinates": [
                [-111.1575, 33.6733],   # Roosevelt Dam
                [-111.2500, 33.6400],
                [-111.3600, 33.6000],
                [-111.4800, 33.5600],
                [-111.6000, 33.5300],
                [-111.7200, 33.4900],
                [-111.8200, 33.4600],
                [-111.9000, 33.4400],
                [-111.9700, 33.4200],   # Confluence with Gila
            ],
            "description": "River runs completely dry; all water diverted to Phoenix metro"
        },
        # Gila River lower reach (seasonal)
        {
            "name": "Gila River lower reach",
            "river": "Gila River",
            "impact_source": "Multiple diversions",
            "flow_status": "seasonal",
            "coordinates": [
                [-111.9700, 33.4200],   # Near Phoenix
                [-112.1500, 33.3900],
                [-112.4000, 33.3700],
                [-112.7000, 33.3200],
                [-113.0000, 33.1800],
                [-113.3000, 32.9800],
                [-113.7000, 32.8200],
                [-114.1000, 32.7400],
                [-114.4533, 32.7200],   # Confluence with Colorado
            ],
            "description": "Ephemeral flow; seasonal water only"
        },
        # Rio Grande below Elephant Butte
        {
            "name": "Rio Grande below Elephant Butte Dam",
            "river": "Rio Grande",
            "impact_source": "Elephant Butte Dam",
            "flow_status": "seasonal",
            "coordinates": [
                [-107.1825, 33.1528],   # Elephant Butte Dam
                [-107.1600, 33.0400],
                [-107.1200, 32.8800],
                [-107.0500, 32.6800],
                [-106.9500, 32.5000],
                [-106.8500, 32.3800],
                [-106.7800, 32.3000],
                [-106.6500, 32.0800],
                [-106.5500, 31.9200],
                [-106.4300, 31.7700],   # El Paso
            ],
            "description": "Often runs dry in summer; irrigation withdrawal exceeds inflow"
        },
    ]

    # === MAJOR AQUEDUCTS including complete CAP ===
    aqueducts = [
        # Central Arizona Project - COMPLETE route from Lake Havasu to Tucson
        {
            "name": "Central Arizona Project (CAP) - Main Canal",
            "infrastructure_type": "aqueduct",
            "system": "CAP",
            "source": "Colorado River (Lake Havasu / Parker Dam)",
            "destination": "Phoenix and Tucson",
            "coordinates": [
                [-114.1364, 34.2939],   # Parker Dam intake
                [-113.9500, 34.2200],
                [-113.7800, 34.1800],
                [-113.6000, 34.1400],
                [-113.4200, 34.0800],
                [-113.2400, 34.0200],
                [-113.0600, 33.9600],
                [-112.8800, 33.9000],
                [-112.7000, 33.8400],
                [-112.5200, 33.7800],
                [-112.3400, 33.7200],
                [-112.1600, 33.6600],
                [-112.0740, 33.4484],   # Phoenix area
                [-111.9500, 33.3200],
                [-111.8200, 33.1800],
                [-111.6800, 33.0400],
                [-111.5400, 32.9000],
                [-111.4000, 32.7600],
                [-111.2600, 32.6200],
                [-111.1200, 32.4800],
                [-110.9747, 32.2226],   # Tucson
            ],
            "description": "336-mile canal bringing Colorado River water to Phoenix and Tucson"
        },
        # Colorado River Aqueduct (updated route following actual inland path)
        {
            "name": "Colorado River Aqueduct (CRA)",
            "infrastructure_type": "aqueduct",
            "system": "CRA",
            "source": "Colorado River (Lake Havasu / Parker Dam)",
            "destination": "Los Angeles, San Diego, Southern California",
            "coordinates": [
                [-114.1364, 34.2939],   # Parker Dam
                [-114.35, 34.18],       # Southeast into desert
                [-114.52, 34.07],
                [-114.72, 33.95],       # Through Mojave Desert
                [-114.95, 33.82],
                [-115.18, 33.70],
                [-115.42, 33.64],       # Low desert near Blythe
                [-115.68, 33.62],
                [-115.95, 33.64],       # Coachella Valley area
                [-116.22, 33.69],       # Begin westward turn
                [-116.48, 33.76],
                [-116.72, 33.84],       # South of San Bernardino Mountains
                [-116.95, 33.93],
                [-117.16, 34.02],       # Through Riverside County
                [-117.36, 34.08],
                [-117.56, 34.11],
                [-117.76, 34.11],       # San Bernardino County
                [-117.96, 34.08],
                [-118.16, 34.06],
                [-118.2437, 34.0522],   # Los Angeles area
            ],
            "description": "242-mile aqueduct supplying Southern California (inland desert route)"
        },
        # All-American Canal
        {
            "name": "All-American Canal",
            "infrastructure_type": "aqueduct",
            "system": "All-American",
            "source": "Colorado River (Imperial Dam)",
            "destination": "Imperial Valley agriculture",
            "coordinates": [
                [-114.4533, 32.8756],   # Imperial Dam
                [-114.6000, 32.8400],
                [-114.7500, 32.8000],
                [-114.9000, 32.7600],
                [-115.0500, 32.7200],
                [-115.2000, 32.6800],
                [-115.3500, 32.6400],
                [-115.5000, 32.6000],
                [-115.5631, 32.7920],   # El Centro area
            ],
            "description": "82-mile canal serving Imperial Valley"
        },
    ]

    # === INFRASTRUCTURE CONNECTIONS (dam â†’ canal intake â†’ cities) ===
    connections = [
        # Parker Dam to CAP intake
        {
            "name": "Parker Dam to CAP Intake",
            "connection_type": "dam_to_canal",
            "from": "Parker Dam",
            "to": "CAP Canal",
            "coordinates": [
                [-114.1364, 34.2939],   # Parker Dam
                [-114.1364, 34.2939],   # CAP intake (same location)
            ],
            "description": "Connection point: Colorado River water enters CAP"
        },
        # CAP to Phoenix
        {
            "name": "CAP to Phoenix",
            "connection_type": "canal_to_city",
            "from": "CAP Canal",
            "to": "Phoenix",
            "coordinates": [
                [-112.1600, 33.6600],   # CAP near Phoenix
                [-112.0740, 33.4484],   # Phoenix
            ],
            "description": "CAP water delivery to Phoenix metro"
        },
        # CAP to Tucson
        {
            "name": "CAP to Tucson",
            "connection_type": "canal_to_city",
            "from": "CAP Canal",
            "to": "Tucson",
            "coordinates": [
                [-111.1200, 32.4800],   # CAP near Tucson
                [-110.9747, 32.2226],   # Tucson
            ],
            "description": "CAP water delivery to Tucson"
        },
        # Parker Dam to CRA intake
        {
            "name": "Parker Dam to CRA Intake",
            "connection_type": "dam_to_canal",
            "from": "Parker Dam",
            "to": "Colorado River Aqueduct",
            "coordinates": [
                [-114.1364, 34.2939],   # Parker Dam
                [-114.4800, 34.1800],   # CRA intake
            ],
            "description": "Connection point: Colorado River water enters CRA"
        },
        # Imperial Dam to All-American Canal
        {
            "name": "Imperial Dam to All-American Canal",
            "connection_type": "dam_to_canal",
            "from": "Imperial Dam",
            "to": "All-American Canal",
            "coordinates": [
                [-114.4533, 32.8756],   # Imperial Dam
                [-114.6000, 32.8400],   # All-American Canal intake
            ],
            "description": "Connection point: Colorado River water enters All-American Canal"
        },
        # Roosevelt Dam to Salt River Project
        {
            "name": "Roosevelt Dam to Phoenix (SRP)",
            "connection_type": "dam_to_city",
            "from": "Roosevelt Dam",
            "to": "Phoenix (via SRP)",
            "coordinates": [
                [-111.1575, 33.6733],   # Roosevelt Dam
                [-111.9700, 33.4200],   # Phoenix area (via dry Salt River bed)
            ],
            "description": "Salt River Project water delivery to Phoenix"
        },
    ]

    # Build GeoJSON
    features = []

    # Add impacted rivers
    for river in impacted_rivers:
        features.append({
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": river["coordinates"]
            },
            "properties": {
                "name": river["name"],
                "river": river["river"],
                "impact_source": river["impact_source"],
                "flow_status": river["flow_status"],
                "description": river["description"],
                "infrastructure_type": "impacted_river"
            }
        })

    # Add aqueducts
    for aqueduct in aqueducts:
        features.append({
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": aqueduct["coordinates"]
            },
            "properties": {
                "name": aqueduct["name"],
                "infrastructure_type": aqueduct["infrastructure_type"],
                "system": aqueduct["system"],
                "source": aqueduct["source"],
                "destination": aqueduct["destination"],
                "description": aqueduct["description"]
            }
        })

    # Add connections
    for connection in connections:
        features.append({
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": connection["coordinates"]
            },
            "properties": {
                "name": connection["name"],
                "connection_type": connection["connection_type"],
                "from": connection["from"],
                "to": connection["to"],
                "description": connection["description"],
                "infrastructure_type": "connection"
            }
        })

    geojson = {
        "type": "FeatureCollection",
        "features": features,
        "metadata": {
            "source": "Enhanced water infrastructure dataset",
            "description": "Detailed impacted rivers, complete aqueduct routes, and infrastructure connections",
            "flow_status_legend": {
                "natural": "Unimpacted natural flow",
                "reduced": "50%+ reduction from historical levels",
                "seasonal": "Flow only during wet season or flood releases",
                "dry": "Perennially dry; complete diversion"
            },
            "connection_types": {
                "dam_to_canal": "Water extraction point from dam/reservoir to canal",
                "canal_to_city": "Water delivery from canal to urban area",
                "dam_to_city": "Direct water delivery from dam to city"
            }
        }
    }

    return geojson

def main():
    print("ðŸŒŠ Creating enhanced water infrastructure GeoJSON...", file=sys.stderr)

    geojson = create_enhanced_infrastructure()

    impacted_count = sum(1 for f in geojson['features'] if f['properties']['infrastructure_type'] == 'impacted_river')
    aqueduct_count = sum(1 for f in geojson['features'] if f['properties']['infrastructure_type'] == 'aqueduct')
    connection_count = sum(1 for f in geojson['features'] if f['properties']['infrastructure_type'] == 'connection')

    print(f"âœ… Created {impacted_count} impacted river segments", file=sys.stderr)
    print(f"âœ… Created {aqueduct_count} aqueduct routes", file=sys.stderr)
    print(f"âœ… Created {connection_count} infrastructure connections", file=sys.stderr)

    # Output GeoJSON to stdout
    print(json.dumps(geojson, indent=2))

if __name__ == "__main__":
    main()
```

**Usage**:
```bash
python3 /tmp/create_enhanced_water_infrastructure.py > enhanced-water-infrastructure.json
```

---

### Script 2: merge_river_depletion.py

**Purpose**: Merges Natural Earth river geometry with depletion status from enhanced-water-infrastructure.json

**Location**: `/tmp/merge_river_depletion.py`

**Full Code**:
```python
#!/usr/bin/env python3
"""
Merge river geometry from north_america_rivers.json with depletion status
from enhanced-water-infrastructure.json to create color-coded rivers
"""
import json
import sys
from typing import Dict, List, Tuple

def find_matching_river_segment(river_name: str, all_rivers: List[Dict]) -> List[Dict]:
    """
    Find river segments that match the impacted river name
    Returns list of matching features
    """
    matches = []

    # Normalize the impacted river name for matching
    search_terms = []
    if "Colorado River" in river_name:
        search_terms = ["Colorado"]
    elif "Salt River" in river_name:
        search_terms = ["Salt"]
    elif "Gila River" in river_name:
        search_terms = ["Gila"]
    elif "Rio Grande" in river_name:
        search_terms = ["Rio Grande", "RÃ­o Grande"]
    elif "Green River" in river_name:
        search_terms = ["Green"]
    elif "San Juan" in river_name:
        search_terms = ["San Juan"]

    for river_feature in all_rivers:
        river_props = river_feature.get('properties', {})
        river_full_name = river_props.get('name', '')

        # Check if any search term matches
        for term in search_terms:
            if term in river_full_name:
                matches.append(river_feature)
                break

    return matches

def calculate_overlap(coords1: List, coords2: List) -> float:
    """
    Calculate approximate overlap between two coordinate sets
    Returns a score 0-1 indicating how much they overlap
    """
    # Simple proximity check - if any points are very close, consider overlap
    overlap_count = 0
    total_checks = min(len(coords1), len(coords2))

    for c1 in coords1[:total_checks]:
        for c2 in coords2[:total_checks]:
            # Check if points are within ~0.5 degrees (rough proximity)
            if abs(c1[0] - c2[0]) < 0.5 and abs(c1[1] - c2[1]) < 0.5:
                overlap_count += 1
                break

    return overlap_count / max(total_checks, 1) if total_checks > 0 else 0

def main():
    # Load the original rivers data
    rivers_path = '/Users/joshuabutler/Documents/github-project/climate-suite/apps/climate-studio/src/data/north_america_rivers.json'
    enhanced_path = '/Users/joshuabutler/Documents/github-project/climate-suite/apps/climate-studio/src/data/enhanced-water-infrastructure.json'

    print("ðŸ“– Loading river data...", file=sys.stderr)
    with open(rivers_path) as f:
        rivers_data = json.load(f)

    print("ðŸ“– Loading enhanced infrastructure data...", file=sys.stderr)
    with open(enhanced_path) as f:
        enhanced_data = json.load(f)

    # Extract impacted river segments with their flow status
    impacted_rivers = [
        f for f in enhanced_data['features']
        if f['properties'].get('infrastructure_type') == 'impacted_river'
    ]

    print(f"âœ… Found {len(impacted_rivers)} impacted river segments", file=sys.stderr)

    # Create a mapping of river name -> flow_status
    river_depletion_map = {}
    for imp_river in impacted_rivers:
        props = imp_river['properties']
        river_name = props.get('river', '')
        flow_status = props.get('flow_status', 'natural')
        impact_source = props.get('impact_source', '')

        # Store the most severe depletion status for each river
        severity_order = {'dry': 4, 'seasonal': 3, 'reduced': 2, 'natural': 1}
        current_severity = severity_order.get(flow_status, 1)

        if river_name not in river_depletion_map:
            river_depletion_map[river_name] = {
                'flow_status': flow_status,
                'severity': current_severity,
                'impact_source': impact_source
            }
        else:
            if current_severity > river_depletion_map[river_name]['severity']:
                river_depletion_map[river_name] = {
                    'flow_status': flow_status,
                    'severity': current_severity,
                    'impact_source': impact_source
                }

    print(f"ðŸ“Š Depletion status for rivers:", file=sys.stderr)
    for river, status in river_depletion_map.items():
        print(f"  - {river}: {status['flow_status']}", file=sys.stderr)

    # Add depletion status to river features
    updated_features = []
    matched_count = 0

    for feature in rivers_data['features']:
        # Copy the feature
        updated_feature = {
            'type': feature['type'],
            'geometry': feature['geometry'],
            'properties': dict(feature.get('properties', {}))
        }

        # Get river name
        river_name = updated_feature['properties'].get('name', '')

        # Check if this river is in our depletion map
        flow_status = 'natural'
        impact_source = None

        for depleted_river, status_info in river_depletion_map.items():
            if depleted_river in river_name or any(term in river_name for term in depleted_river.split()):
                flow_status = status_info['flow_status']
                impact_source = status_info['impact_source']
                matched_count += 1
                print(f"  âœ“ Matched: {river_name} -> {flow_status}", file=sys.stderr)
                break

        # Add depletion properties
        updated_feature['properties']['flow_status'] = flow_status
        if impact_source:
            updated_feature['properties']['impact_source'] = impact_source

        updated_features.append(updated_feature)

    print(f"âœ… Matched {matched_count} river features with depletion data", file=sys.stderr)

    # Create the output GeoJSON
    output_data = {
        'type': 'FeatureCollection',
        'features': updated_features,
        'metadata': {
            'source': 'Natural Earth rivers with depletion status overlay',
            'description': 'Rivers color-coded by flow depletion status',
            'flow_status_legend': {
                'natural': 'Unimpacted natural flow',
                'reduced': '50%+ reduction from historical levels',
                'seasonal': 'Flow only during wet season or flood releases',
                'dry': 'Perennially dry; complete diversion'
            }
        }
    }

    # Output to stdout
    print(json.dumps(output_data, indent=2))

if __name__ == "__main__":
    main()
```

**Usage**:
```bash
python3 /tmp/merge_river_depletion.py > rivers-with-depletion.json
```

---

## 3. View Construction in Mapbox GL / React

### Layer Order (Bottom to Top)

1. **Base Map** (Mapbox Streets)
2. **GRACE Layer** (Raster tiles - groundwater depletion zones)
3. **Aquifers Layer** (Vector polygons)
4. **Rivers Layer** (Color-coded by flow_status)
5. **Canals/Aqueducts Layer** (Solid cyan lines) - **NEW**
6. **Service Areas Layer** (City points)

### Mapbox GL Rivers Layer Configuration

**Source**:
```javascript
map.addSource('rivers-with-depletion', {
  type: 'geojson',
  data: '/data/rivers-with-depletion.json'
});
```

**Layer Paint Properties**:
```javascript
map.addLayer({
  id: 'rivers-layer',
  type: 'line',
  source: 'rivers-with-depletion',
  paint: {
    'line-color': [
      'match',
      ['get', 'flow_status'],
      'dry', '#dc2626',        // Red
      'seasonal', '#f59e0b',   // Orange
      'reduced', '#fbbf24',    // Yellow
      '#3b82f6'                // Blue (natural/default)
    ],
    'line-width': [
      'interpolate',
      ['linear'],
      ['get', 'scalerank'],
      0, 3,      // Major rivers (scalerank 0) = 3px wide
      10, 0.5    // Minor streams (scalerank 10) = 0.5px wide
    ]
  }
});
```

### Canals/Aqueducts Layer Configuration

**Source**:
```javascript
// Extract aqueduct features from enhanced infrastructure data
const canals = {
  type: 'FeatureCollection',
  features: enhancedInfrastructureData.features.filter(f =>
    f.properties.infrastructure_type === 'aqueduct'
  )
};

map.addSource('canals', {
  type: 'geojson',
  data: canals
});
```

**Layer Paint Properties**:
```javascript
// Casing layer (darker outline)
map.addLayer({
  id: 'canal-lines-casing',
  type: 'line',
  source: 'canals',
  paint: {
    'line-color': '#0891b2',  // Dark cyan
    'line-width': 5,
    'line-opacity': 0.9
  }
});

// Main canal layer (solid cyan)
map.addLayer({
  id: 'canal-lines',
  type: 'line',
  source: 'canals',
  paint: {
    'line-color': '#06b6d4',  // Cyan
    'line-width': 3,
    'line-opacity': 0.9
  }
});
```

**Features Displayed**:
- Central Arizona Project (CAP): Parker Dam â†’ Phoenix â†’ Tucson
- Colorado River Aqueduct (CRA): Parker Dam â†’ Los Angeles (inland desert route)
- All-American Canal: Imperial Dam â†’ Imperial Valley

---

### Service Areas Layer Configuration

**Source**:
```javascript
map.addSource('service-areas', {
  type: 'geojson',
  data: '/data/water-service-areas.json'
});
```

**Layer Paint Properties**:
```javascript
map.addLayer({
  id: 'service-areas',
  type: 'circle',
  source: 'service-areas',
  paint: {
    'circle-radius': [
      'interpolate',
      ['linear'],
      ['get', 'population'],
      0, 4,
      4000000, 12
    ],
    'circle-color': [
      'match',
      ['get', 'dependency'],
      'extreme', '#ef4444',
      'high', '#f97316',
      'moderate', '#eab308',
      '#22c55e'  // low
    ],
    'circle-opacity': 0.7,
    'circle-stroke-width': 1,
    'circle-stroke-color': '#ffffff'
  }
});
```

---

## 4. QGIS Implementation Guide

### Step 1: Import Rivers Layer

1. **Add Vector Layer**: Load `rivers-with-depletion.json`
2. **Style by flow_status**:
   - Open Layer Properties â†’ Symbology
   - Choose "Categorized" style
   - Column: `flow_status`
   - Add values:
     - `dry` â†’ Red (#dc2626), 2px width
     - `seasonal` â†’ Orange (#f59e0b), 2px width
     - `reduced` â†’ Yellow (#fbbf24), 2px width
     - `natural` â†’ Blue (#3b82f6), 2px width

3. **Optional: Scale-based width**:
   - Use "Data Defined Override" on line width
   - Expression: `3 - (scalerank * 0.25)` (larger scalerank = thinner line)

### Step 2: Import Canals/Aqueducts Layer

1. **Add Vector Layer**: Load `enhanced-water-infrastructure.json`
2. **Filter for aqueducts**:
   - Layer Properties â†’ Source â†’ Query Builder
   - Filter: `"infrastructure_type" = 'aqueduct'`
3. **Style as solid cyan lines**:
   - Symbology â†’ Simple Line
   - Color: Cyan (#06b6d4)
   - Width: 3px
   - Add outline:
     - Symbol Layer Type: Simple Line
     - Color: Dark Cyan (#0891b2)
     - Width: 5px
     - Place below main line
4. **Add labels**:
   - Expression: `"name"`
   - Placement: Curved along line
   - Font size: 9pt

**Features**:
- Central Arizona Project (CAP)
- Colorado River Aqueduct (CRA) - inland desert route
- All-American Canal

---

### Step 3: Import Service Areas Layer

1. **Add Vector Layer**: Load `water-service-areas.json`
2. **Style by dependency**:
   - Symbology â†’ Categorized
   - Column: `dependency`
   - Values:
     - `extreme` â†’ Red (#ef4444)
     - `high` â†’ Orange (#f97316)
     - `moderate` â†’ Yellow (#eab308)
     - `low` â†’ Green (#22c55e)

3. **Size by population**:
   - Use "Data Defined Override" on marker size
   - Expression: `4 + (population / 500000)` (scales circle size)

### Step 3: Add Labels

**For Rivers**:
- Expression: `name || '\n(' || flow_status || ')'`
- Placement: Curved along line
- Font size: 10pt
- Buffer: White background

**For Service Areas**:
- Expression: `city || '\n' || format_number(population, 0) || ' pop.'`
- Placement: Above point
- Font size: 9pt

### Step 4: Layer Order in QGIS

1. Service Areas (top)
2. Canals/Aqueducts - **NEW**
3. Rivers with Depletion
4. Aquifers (if available)
5. GRACE Raster (if available)
6. Base Map (bottom)

---

## 5. Color Schemes Summary

### Flow Status Colors
| Status | Hex Color | RGB | Description |
|--------|-----------|-----|-------------|
| Dry | `#dc2626` | rgb(220, 38, 38) | Perennially dry; complete diversion |
| Seasonal | `#f59e0b` | rgb(245, 158, 11) | Wet season only; flood releases |
| Reduced | `#fbbf24` | rgb(251, 191, 36) | 50%+ reduction from historical levels |
| Natural | `#3b82f6` | rgb(59, 130, 246) | Unimpacted natural flow |

### Dependency Colors
| Level | Hex Color | RGB | Range |
|-------|-----------|-----|-------|
| Extreme | `#ef4444` | rgb(239, 68, 68) | 90-100% dependency |
| High | `#f97316` | rgb(249, 115, 22) | 60-90% dependency |
| Moderate | `#eab308` | rgb(234, 179, 8) | 30-60% dependency |
| Low | `#22c55e` | rgb(34, 197, 94) | <30% dependency |

---

## 6. Data Processing Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Create Infrastructure Data                         â”‚
â”‚ Script: create_enhanced_water_infrastructure.py            â”‚
â”‚ Output: enhanced-water-infrastructure.json                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Merge with Natural Earth Rivers                    â”‚
â”‚ Script: merge_river_depletion.py                           â”‚
â”‚ Inputs: north_america_rivers.json                          â”‚
â”‚         enhanced-water-infrastructure.json                 â”‚
â”‚ Output: rivers-with-depletion.json (4.8MB)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Render in Mapbox GL                                â”‚
â”‚ Component: WaterAccessView.tsx                             â”‚
â”‚ Data Sources: rivers-with-depletion.json                   â”‚
â”‚               water-service-areas.json                     â”‚
â”‚ Styling: Data-driven expressions based on flow_status      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Key Mapbox Expression Patterns

### Color Matching by Property
```javascript
[
  'match',
  ['get', 'property_name'],
  'value1', '#color1',
  'value2', '#color2',
  '#default_color'  // fallback
]
```

### Interpolation by Numeric Property
```javascript
[
  'interpolate',
  ['linear'],
  ['get', 'numeric_property'],
  min_value, min_output,
  max_value, max_output
]
```

### Conditional Visibility
```javascript
[
  'case',
  ['==', ['get', 'flow_status'], 'dry'], true,
  false
]
```

---

## 8. UI Widget System

### Rivers Legend Widget
**Visibility**: Shows when `showRiversLayer === true`
**Content**: Color swatches + flow status descriptions

### Groundwater & Aquifer Depletions Widget
**Visibility**: Shows when `showGRACELayer || showAquifersLayer`
**Content**:
- Checkboxes to toggle GRACE layer
- Checkboxes to toggle Aquifer layer
- Legend/info for each layer

---

## 9. Known Rivers with Flow Status

Based on merge_river_depletion.py matching:

**Dry Rivers**:
- Colorado River Delta
- Salt River (below Roosevelt Dam)

**Seasonal Rivers**:
- Colorado River below Imperial Dam
- Gila River lower reach
- Rio Grande below Elephant Butte Dam

**Reduced Flow Rivers**:
- Colorado River below Hoover Dam
- Colorado River below Davis Dam
- Colorado River below Parker Dam

**Natural Flow Rivers**:
- All other rivers in Natural Earth dataset

---

## 10. Complete File Paths Reference

```
Project Root: /Users/joshuabutler/Documents/github-project/climate-suite/

Data Files:
â”œâ”€â”€ apps/climate-studio/src/data/
â”‚   â”œâ”€â”€ rivers-with-depletion.json (4.8MB) - PRIMARY RIVER LAYER
â”‚   â”œâ”€â”€ water-service-areas.json - CITY POINTS
â”‚   â”œâ”€â”€ enhanced-water-infrastructure.json - REFERENCE DATA
â”‚   â””â”€â”€ north_america_rivers.json - SOURCE DATA

Python Scripts:
â”œâ”€â”€ /tmp/
â”‚   â”œâ”€â”€ create_enhanced_water_infrastructure.py
â”‚   â””â”€â”€ merge_river_depletion.py

React Component:
â””â”€â”€ apps/climate-studio/src/components/
    â””â”€â”€ WaterAccessView.tsx
```
