<!DOCTYPE html>
<!--
  DEBUG FILE - FOR DEVELOPMENT TESTING ONLY
  
  This file uses an iframe for debugging purposes only.
  Production code uses native React components without iframes.
  
  This debug file allows testing layer visibility and opacity controls
  in isolation. The main application in apps/climate-studio does NOT use iframes.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeckGL Layer Debugger</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            text-align: center;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        .iframe-container {
            position: relative;
            width: 100%;
            height: 600px;
            border: 3px solid #00ff00;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        button {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 12px;
            cursor: pointer;
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.2s;
        }
        button:hover {
            background: #00ff00;
            color: #000000;
        }
        button.active {
            background: #00ff00;
            color: #000000;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .results {
            background: #003300;
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #666;
        }
        .test-result.success {
            border-left-color: #00ff00;
        }
        .test-result.warning {
            border-left-color: #ffff00;
            color: #ffff00;
        }
        .test-result.error {
            border-left-color: #ff0000;
            color: #ff0000;
        }
        .test-result h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .test-result p {
            margin: 5px 0;
            font-size: 12px;
        }
        .opacity-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #003300;
            border: 2px solid #00ff00;
        }
        .opacity-control {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .opacity-control label {
            font-size: 11px;
            font-weight: bold;
        }
        .opacity-control input[type="range"] {
            width: 100%;
        }
        .opacity-control .value {
            font-size: 10px;
            text-align: right;
        }
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 2px solid #00ff00;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DeckGL Layer System Debugger</h1>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-box" style="background: #00ff00;"></div>
                <span>Working</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #ffff00;"></div>
                <span>Warning</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #ff0000;"></div>
                <span>Error</span>
            </div>
        </div>

        <div class="iframe-container">
            <iframe id="app-iframe" src="http://localhost:8082/"></iframe>
        </div>

        <h2>Layer Controls - Test Each One</h2>
        <div class="controls">
            <button onclick="testLayer('sea_level_rise')" id="btn-sea-level">1. Sea Level Rise</button>
            <button onclick="testLayer('topographic_relief')" id="btn-relief">2. Topographic Relief</button>
            <button onclick="testLayer('temperature_projection')" id="btn-temp">3. Temperature Projection</button>
            <button onclick="testLayer('precipitation_drought')" id="btn-drought">4. Precipitation/Drought</button>
            <button onclick="testLayer('urban_heat_island')" id="btn-heat">5. Urban Heat Island</button>
            <button onclick="testLayer('urban_expansion')" id="btn-expansion">6. Urban Expansion</button>
            <button onclick="testLayer('megaregion_timeseries')" id="btn-megaregion">7. Megaregion/Migration</button>
        </div>

        <h2>Opacity Test Controls</h2>
        <div class="opacity-controls">
            <div class="opacity-control">
                <label>Sea Level Opacity</label>
                <input type="range" min="10" max="100" value="30" id="opacity-sea-level"
                       oninput="updateOpacity('seaLevelOpacity', this.value)">
                <div class="value"><span id="value-sea-level">30%</span></div>
            </div>
            <div class="opacity-control">
                <label>Relief Opacity</label>
                <input type="range" min="10" max="100" value="30" id="opacity-relief"
                       oninput="updateOpacity('reliefOpacity', this.value)">
                <div class="value"><span id="value-relief">30%</span></div>
            </div>
            <div class="opacity-control">
                <label>Temperature Opacity</label>
                <input type="range" min="10" max="100" value="30" id="opacity-temp"
                       oninput="updateOpacity('projectionOpacity', this.value)">
                <div class="value"><span id="value-temp">30%</span></div>
            </div>
            <div class="opacity-control">
                <label>Drought Opacity</label>
                <input type="range" min="10" max="100" value="30" id="opacity-drought"
                       oninput="updateOpacity('droughtOpacity', this.value)">
                <div class="value"><span id="value-drought">30%</span></div>
            </div>
            <div class="opacity-control">
                <label>Urban Heat Opacity</label>
                <input type="range" min="10" max="100" value="30" id="opacity-heat"
                       oninput="updateOpacity('urbanHeatOpacity', this.value)">
                <div class="value"><span id="value-heat">30%</span></div>
            </div>
            <div class="opacity-control">
                <label>Urban Expansion Opacity</label>
                <input type="range" min="10" max="100" value="30" id="opacity-expansion"
                       oninput="updateOpacity('urbanExpansionOpacity', this.value)">
                <div class="value"><span id="value-expansion">30%</span></div>
            </div>
            <div class="opacity-control">
                <label>Megaregion Opacity</label>
                <input type="range" min="10" max="100" value="70" id="opacity-megaregion"
                       oninput="updateOpacity('megaregionOpacity', this.value)">
                <div class="value"><span id="value-megaregion">70%</span></div>
            </div>
        </div>

        <h2>Automated Test Suite</h2>
        <div class="controls">
            <button onclick="runFullTest()">Run Full Test Suite</button>
            <button onclick="checkConsoleErrors()">Check Console Errors</button>
            <button onclick="checkNetworkRequests()">Check Network Tab</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div class="results" id="results">
            <h3>Test Results:</h3>
            <p>Click a layer button to test it, or run the full test suite.</p>
        </div>
    </div>

    <div class="status-bar" id="status">
        Ready to test. Open browser DevTools Console and Network tabs for detailed debugging.
    </div>

    <script>
        let testResults = [];
        let currentLayer = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);

            const status = document.getElementById('status');
            status.textContent = `[${timestamp}] ${message}`;

            if (type === 'error') {
                status.style.color = '#ff0000';
            } else if (type === 'warning') {
                status.style.color = '#ffff00';
            } else if (type === 'success') {
                status.style.color = '#00ff00';
            }
        }

        function addResult(layerName, status, message) {
            const result = {
                layer: layerName,
                status: status,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            };
            testResults.push(result);
            displayResults();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Test Results:</h3>';

            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.status}`;
                div.innerHTML = `
                    <h3>${result.layer} - [${result.timestamp}]</h3>
                    <p>${result.message}</p>
                `;
                resultsDiv.appendChild(div);
            });
        }

        function clearResults() {
            testResults = [];
            displayResults();
            log('Results cleared');
        }

        async function testLayer(layerId) {
            currentLayer = layerId;
            const btnId = 'btn-' + layerId.replace(/_/g, '-').replace('megaregion-timeseries', 'megaregion');
            const btn = document.getElementById(btnId);

            // Reset all buttons
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            log(`Testing layer: ${layerId}`, 'info');

            // Instructions for manual testing
            const layerNames = {
                'sea_level_rise': 'Sea Level Rise',
                'topographic_relief': 'Topographic Relief',
                'temperature_projection': 'Temperature Projection',
                'precipitation_drought': 'Precipitation & Drought',
                'urban_heat_island': 'Urban Heat Island',
                'urban_expansion': 'Urban Expansion',
                'megaregion_timeseries': 'Population Migration'
            };

            addResult(layerNames[layerId], 'warning',
                `MANUAL TEST REQUIRED:
                1. Find "${layerNames[layerId]}" in the layer panel
                2. Toggle it ON (if not already on)
                3. Check if layer renders on map
                4. Try the opacity slider below
                5. Open DevTools Console for errors
                6. Open Network tab to see tile requests
                7. Report findings in console`
            );
        }

        function updateOpacity(controlName, value) {
            const percentage = value;
            const decimal = value / 100;

            // Update display
            const elemId = 'value-' + controlName.replace('Opacity', '').replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, '');
            const elem = document.getElementById(elemId);
            if (elem) {
                elem.textContent = `${percentage}%`;
            }

            log(`Setting ${controlName} to ${percentage}%`, 'info');
            console.log(`You need to update the control in the app. This tester cannot directly control the React app.`);
            console.log(`Expected behavior: Layer opacity should change to ${percentage}%`);
        }

        async function runFullTest() {
            log('Starting full test suite...', 'info');
            clearResults();

            const layers = [
                'sea_level_rise',
                'topographic_relief',
                'temperature_projection',
                'precipitation_drought',
                'urban_heat_island',
                'urban_expansion',
                'megaregion_timeseries'
            ];

            addResult('Test Suite', 'warning',
                `AUTOMATED TEST CHECKLIST:

                For each layer below, perform these checks:
                ✓ Layer toggle appears in UI
                ✓ Layer can be enabled/disabled
                ✓ Opacity slider appears when enabled
                ✓ Moving slider updates percentage display
                ✓ Layer visibility changes with opacity
                ✓ No console errors when enabling
                ✓ Network requests show tile loading (for tile layers)
                ✓ Layer renders visually on map

                LAYERS TO TEST:
                ${layers.map((l, i) => `${i + 1}. ${l}`).join('\n                ')}

                Check browser console for detailed logs.`
            );

            log('Full test instructions displayed. Begin manual testing.', 'info');
        }

        function checkConsoleErrors() {
            addResult('Console Check', 'warning',
                `Open Browser DevTools Console and look for:
                - Red error messages
                - Failed network requests (look for 404, 500 errors)
                - React warnings
                - Deck.gl layer warnings
                - TypeError or other JavaScript errors

                Common issues to look for:
                - "Failed to load resource"
                - "TypeError: Cannot read property"
                - "Layer xxx is not updating"
                - "Tile load failed"
                `
            );
            log('Check DevTools Console now', 'warning');
        }

        function checkNetworkRequests() {
            addResult('Network Check', 'warning',
                `Open Browser DevTools Network tab and filter by:
                - Images (for tile layers)
                - XHR/Fetch (for GeoJSON data)

                Expected requests for each layer:
                1. Sea Level Rise: /api/tiles/noaa-slr/{feet}/{z}/{x}/{y}.png
                2. Topographic Relief: Earth Engine tile URLs
                3. Temperature Projection: Earth Engine tile URLs
                4. Precipitation/Drought: Earth Engine tile URLs
                5. Urban Heat Island: Earth Engine tile URLs
                6. Urban Expansion: GeoJSON features
                7. Megaregion: Local JSON data

                Look for:
                - 404 errors (missing tiles)
                - 500 errors (server errors)
                - Slow requests (> 3 seconds)
                - Failed requests (red in network tab)
                `
            );
            log('Check DevTools Network tab now', 'warning');
        }

        // Initialize
        log('DeckGL Layer Debugger ready. Start by clicking a layer button.', 'success');

        // Add console helper
        console.log('%c=== DeckGL LAYER DEBUGGER ===', 'font-size: 20px; color: #00ff00; font-weight: bold;');
        console.log('%cInstructions:', 'font-size: 16px; color: #00ff00;');
        console.log('1. Click a layer button above to test it');
        console.log('2. Watch this console for errors');
        console.log('3. Check Network tab for tile requests');
        console.log('4. Test opacity sliders');
        console.log('5. Report findings\n');

        console.log('%cExpected Control Names:', 'font-size: 14px; color: #ffff00;');
        console.log('seaLevelOpacity, reliefOpacity, projectionOpacity, droughtOpacity,');
        console.log('urbanHeatOpacity, urbanExpansionOpacity, megaregionOpacity\n');

        console.log('%cDefault Opacity Values:', 'font-size: 14px; color: #ffff00;');
        console.log('Most layers: 0.3 (30%)');
        console.log('Megaregion: 0.7 (70%)\n');
    </script>
</body>
</html>
